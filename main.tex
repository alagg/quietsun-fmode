%\documentclass[twocolumn,linenumbers,trackchanges]{tex/aastex631}
\documentclass{aa}
\usepackage{xcolor}
\usepackage{trackchanges}
\usepackage{gensymb}
\usepackage[colorlinks,allcolors=blue]{hyperref}
%\input{journal} 

\input{macros}
\graphicspath{{./figures/}}

\begin{document}
%\title{Quiet-Sun Magnetism Depends on Solar Activity}
\title{Solar-Cycle Variation of quiet-Sun Magnetism and surface gravity oscillation mode}
%\shorttitle{Quiet-Sun Solar Activity}
\titlerunning{Quiet-Sun Solar Activity}

\input{authors}

\abstract{Bla}{Bla}{Bla}{Bla}{Bla}

%\end{abstract}

%% Keywords should appear after the \end{abstract} command. 
%% The AAS Journals now uses Unified Astronomy Thesaurus concepts:
%% https://astrothesaurus.org
%% You will be asked to selected these concepts during the submission process
%% but this old "keyword" functionality is maintained in case authors want
%% to include these concepts in their preprints.
\keywords{Sun}

\maketitle

\section{Introduction} \label{sec:intro}

\begin{itemize}
\item quiet Sun magnetism is weak. Measurement requires high sensitivity, high spatial resolution, otherwise signal cancellation. Variations in quiet Sun magnetism are even tougher to detect. Require long-term stability, constant conditions, HMI offers this, now 1 solar cycle in orbit. 
\item what is the quiet Sun? simple: No AR. 98\% of the solar surface are in this state. But even the quiet regions are structured: network / internetwork. 
\item what is expected to vary with solar cycle? network, IN, both, or nothing? A few words about the expectations.
\item argue why taking into account network is important: the IN flux is advected towards the network boundaries. A cycle variation of the IN flux therefore should be reflected in a variation of the network flux. Network accumulates IN flux and therefore acts as a memory of what happened in the IN. Helps to overcome detection of the weak IN fields (difficult enough), even more difficult to study variations of these weak fields.
\item HMI: compared to Hinode / ground based / Sunrise: not the most sensitive instrument to B. But: Stability allows averaging. 8 hr time and spatial averaging allows to boost S/N ratio (can we give a number here?)

\end{itemize}

\cite[]{2019LRSP...16....1B}
Luis Talk PHI meeting: 38\% of the flux emerging in the IN makes it to the network. Network flux is constant, the IN flux to the network accumulates quickly to network flux.

\cite[]{2015ApJ...806..174J}

\cite[]{2013A&A...555A..33B}

\cite[]{2021arXiv210508657F}

\cite[]{2021arXiv210514533R}

\cite[]{ballot2021changes}

\section{Observations}

HMI data sets used, and removal of long-term trend

Key issue: 
How to obtain the most reliable HMI data product telling us about the variability of the quiet Sun magnetism during a solar cycle? Idea: combine spatial and temporal averaging, and analyze the statistics in space-time cubes to determine the level of quietness as a function of latitude. This requires the magnetic field information coming from specro-polarimetry. 

In a next step, derive a data product not relying on spectropolarimetry, but on the \los{} velocity maps. The $f$-mode power provides an independent measure to quantify the solar cycle variation.

But first the boring stuff: How to obtain a clean, 11-year long data set:

About the long term trend: The jump in the data happened on 13 April 2016 (search for this date in \cite{2018SoPh..293...45H}). There it states:
\begin{itemize}
\item Standard HMI observations were initially obtained with a framelist called Mod-C that
repeated every 135 seconds. Mod-L, a 90-second FTS, replaced Mod-C on 13 April 2016.
The two versions of Mod-C have FTS ID 1001 or 1021; the Mod-L HFTSACID is 1022.
Some calibration framelists changed when the standard sequences changed.
\item Since 13 April
2016, filtergrams from the two cameras have been combined to compute the vector magnetic
field \cite[]{2014SoPh..289.3483H,2016SoPh..291.1887C}
\item On 13 April 2016, after the prime mission ended, HMI switched to
a faster sequence, FTS ID 1022, also known as Mod-L. The Mod-L sequence requires that
images from both cameras be combined to determine the vector-field observables. 
\end{itemize}
Mod-L description here: http://hmi.stanford.edu/hminuggets/?p=1596: \textsl{
Mod-L provides all of the filtergrams necessary to compute the Stokes parameters [I, Q, U, V] in 90 seconds, instead of the 135 seconds required for Mod-C. Thus Mod-L increases the maximum temporal resolution for measuring full Stokes parameters. At the same time, it decreases the noise because twice as many filtergrams are available. The 45s data products from the front camera are also improved; since there is no longer a 135s period in the instrument configuration, the corresponding peak in the Doppler power spectrum is now gone. The new 90s period is at the Nyquist frequency of the 45s-cadence Doppler data. The Stokes measurement is normally averaged over time (nominally 720 seconds) to derive [I, Q, U, V], and we now combine three times as many CP and 1.5 times as many LP measurements. Table 1 compares the Mod-C and Mod-L observations.}

\subsection{Correction for HMI sensitivity change}

On April 13 2016 HMI switched to a more efficient observing mode. By combining both HMI cameras to determine the vector-field observables the cadence for full-disk magnetograms could be reduced from 135\,s (observational mode MOD-C) to 90\,s (MOD-L). This reduced the noise level for Stokes $V$ measurements by 17\%, resulting in a decrease of the noise level in the \los{} magnetograms by 5\%.

For the long-term study presented in this paper, we need to correct for this sensitivity change. A very accurate correction method can be derived from the \IN{} dataset: since it contains only the most quiet pixels over a certain latitude region and time, the sensitivity change results in a step function. The value of the step was determined by fitting a polynomial to the \brms{} values determined from the \IN{} dataset plus a Heaviside step function, centered at the date of the mode change. We used the Bayesian information criterion (BIC)\cite[]{Stoica2004}
%NO Added same ref Jyri used in his paper
to determine the degree of the polynomial, which lies between 1 and 6 for the various latitudes. We want to note that the retrieved amplitude of the Heaviside step function is only weakly dependant on the degree of the polynomial. This fitting is exemplified in \fig{fit-offset} for the solar latitude 0$^\circ$, where the minimum value for the BIC was reached for a fit with a polynomial of degree 4. The so determined amplitude of the Heaviside step function is added to the data points after 13 April 2016 for all data presented in this paper.

\colfig{fit-offset}{Determination of the correction for the HMI sensitivity change: the observing mode change on April 13 2016 causes a discontinuity in the level of \brms{} values of the \IN{} data. The original data are displayed in with the dark red and black dots, the corrected data with the light red dots. The dashed line indicates the polynomial fit of degree 4 used to obtain the offset.}

Mention also the focus change in 2018-10-16, leading to a change in the \los{} maps. 

HMI 720s full disk magnetograms; 
Define \brms{}.

\section{Data pipeline}
In the following we describe the full data processing pipeline for obtaining the final products. The detailed data pipeline is summarized in \fig{pipeline}.
\colfig{pipeline}{Data pipeline}

%\input{pipelinedesign}
\subsection{Magnetogram tracking}
The full HMI magnetograms starting from 27.04.2010 and ending at \todo{Insert the date at the moment we have produced the final plot} were tracked for 8 hours to compensate for the solar rotation. The step between tracked sequences was 4 hours, so that total of 6 tracked sequences were gathered per one day. For each tracked sequence the visible solar disk between latitudes and longitudes from $-80\degree$ to +$80\degree$ was divided into $64\times 64$ grid of $15\degree$ overlapping patches and the following statistics were collected:
\begin{itemize}
	\item $\mu_B$ -- Mean of the magnetic field strength
	\item $\sigma_B$ -- Standard deviation of the magnetic field strength
	\item ${\rm skew}_B$ -- Skewness of the magnetic field strength
	\item ${\rm kurt}_B$ -- Kurtosis of the magnetic field strength
	\item $\mu_{|B|}$ -- Mean of the absolute value of the magnetic field strength
    \item $\sigma_{|B|}$ --Standard deviation of the absolute value of the magnetic field strength
    \item ${\rm skew}_{|B|}$ -- Skewness of the absolute value of the magnetic field strength
    \item ${\rm kurt}_{|B|}$ --Kurtosis of the absolute value of the magnetic field strength
	\item $\sqrt{\mu_{B^2}}$ -- Root mean square of the magnetic field strength
    \item $\sqrt{\sigma:{B^2}}$ -- Root mean square of the standard deviation of the magnetic field strength
    \item $\sqrt{{\rm skew}_{B^2}}$ -- Root mean square of the skewness of the magnetic field strength
    \item $\sqrt{{\rm kurt}_{B^2}}$ -- Root mean square of the kurtosis of the magnetic field strength
\end{itemize}
These statistics for each patch were stored as data products (see also \fig{pipeline}) including the information about latitudinal and longitudinal position as well as the Carrington longitude.

\todo{We should mention the effect of the HMI 24hr modulation of the B-field measurement, and check how it affects the values we derive.}

\subsection{Quiet sun region selection}

\subsection{Analysis of quiet sun dopplerograms}
The dopplerogram data is located in MPS server (Germany) whereas the analysis is executed in the CSC supercomputing environment (Finland). We have utilized  a function-as-a-service based on funcX \cite[]{chard20funcx} for accessing the required data in the database server. We have developed functions based on funcX API and deployed the functions in the MPS environment. These functions leverage mtrack\footnote{\url{http://hmi.stanford.edu/teams/rings/modules/mtrack/v25.html}} command to retrieve dopplerogram cubes and moved the cubes data to the CSC environment. The coordinates of the selected quiet sun regions were sent to the funcX service, which invokes suitable functions to automate the data retrieval and movement.
%{the using remote function call service funcX \cite{chard20funcx} to MPS server where the dopplerogram database is located. Next, using mtrack command the tracked dopplerogram cubes were retrieved and sent back to CSC supercomputing environment.}

\subsubsection*{Computation of the $f$-mode power}

In the CSC environment, subsequent processing involved calculating the 3d power spectra for each dopplerogram cube and averaging the spectra azimuthally in $k_x, k_y$ plane for each constant $\omega$. Such averaging significantly reduced the noise level leading to smooth one dimensional $k-\omega$ spectra. Such averaging is justified for the quiet sun spectra, as the ring diagrams are radially symmetrical w.r.t. $\omega$ axis. From the obtained spectra $f$-mode was easily separable from the rest of the modes and integration done over $k$ and $\omega$, to obtain full power of the $f$-mode. The integration range was chosen between $\omega$ values starting from 14.45 and ending at 29.03, where the significant part of the $f$-mode power resides. After completing described steps we had collected total of 18327 $f$-mode powers for patches close to central meridian over all latitudes covering the full solar cycle.

\subsubsection*{Orbital correction of the $f$-mode power}

%AL We have to be consistent. Do we call it f-mode power, strength or area?
Since the $f$-mode power is computed from the \los{} dopplergrams, its value depends strongly on the viewing geometry. This dependence,  roughly following the cosine of the solar latitude for data taken at the central meridian, is additionally modulated by the orbital motion of the Earth around the Sun, which changes the viewing angle at any given solar latitude by $\approx\pm7^\circ$ during one year. We compensated for this periodic variation by fitting the parameters ($x_0(\lambda)...x_3(\lambda)$) of the following function for all observations of a given latitude $\lambda$:
\begin{equation}
\label{eq:orbitcorr}
A_{\mbox{corr}}(\lambda) = x_0(\lambda) (  2 ( (1+\cos(\alpha+x_1(\lambda)))/2)^{x_3(\lambda)}-1   )+ x_2(\lambda),
\end{equation}
with $\alpha$ being the phase angle of the Earth defined as the cotangens computed from the $x,y$ barycentric position of the Earth.
This correction $A_{\mbox{corr}}(\lambda)$ is then subtracted from the computed $f$-mode area, which efficiently removes any yearly variation. 

\section{Results}





definition of quiet regions in space and time: 
The \brms{} computed over an area of 15$^\circ$ in latitude and longitude over a time of 8 hours. The solar rotation is compensated by taking into account the Carrington rotation only. A region is defined to be quiet when the \brms{} belongs to the 10\% most quiet patches every month.

\colfig{Brms-lat00-percentile}{\brms{} determined from the most quiet patches from 2010 to 2021 at disk center. The patches of 15$^\circ$ size in longitude and latitude contain network and \IN{} fields. The solid red lines display the 97\% percentile level, the dashed, gray line the mode of a log-normal fit to yearly-binned data moved in a sliding window of 100 days length.}

\colfig{Brms-lat00-percentile-IN}{Same as \fig{Brms-lat00-percentile}, but for \brms{} determined from patch size of only of 1$^\circ$ in longitude and latitude, corresponding to \IN{} patches. }


\subsection{Butterfly}

Definitions:\\
$\lambda$ = latitude, $t$=time, \\
$N_t$ = number of bins in time \\
$N_\lambda$ = number of bins in latitude, \\
$n_t$ = total number of time points at a certain latitude, \\
$N_P$ = number of $f$-mode measurements in a patch, \\
$\overline{X}$ indicates average over full time span, \\
$\left< X \right>$ indicates an average in a selected bin, \\
%AL: The <> would remove the necessity for the subscript _P, 
% which meant exactly the same
% I removed all the _P and replaced it by <>
$f(\lambda,t)$ = $f$-mode strength \\
%AL removed _P
%$\left<f_P\right>=1/N_P \sum_{N_P} f (\lambda,t)$ = mean $f$-mode strength 
$\left< f \right>=1/N_P \sum_{N_P} f (\lambda,t)$ = mean $f$-mode strength calculated in patches of $N_t$ and $N_\lambda$ \\
$\overline{f}(\lambda) = 1/n_t \sum_t f(\lambda,t)$ = temporal mean of the $f$-mode strength, \\
%MJK This is what is plotted in the butterfly, and should appear in title/caption.
%MJK It is further binned for plotting, the explanation of which is still missing, but this should not be here, but in the figure caption.
$f'=f-\overline{f}$ is the fluctuation around the temporal mean, i.e. the solar cycle dependence of the $f$-mode.\\
%AL: In the butterfly we plot the binned f'. It is computed like this:
$\left< f' \right> = \left< f - \overline{f} \right> $ is the same as $f'$, but computed in $N_\lambda \times N_P$ bins. This is the quantity we show in the left panel of \fig{butterfly_lat}.
%MJK Added
We assume that the solar cycle variation is a sinusoidal function, the amplitude of which can be approximated as 
%AL Would it be more correct if we also use <> around the quantity f'_A?
$f'_{\rm A} (\lambda) = 
\sqrt{2} \sqrt{\left<{f'^2}\right>}$. 
The average over the bin is necessary to remove the noise from the estimate.
%AL added
This quantity $f'_{\rm A} (\lambda)$ is plotted as the orange shaded area in the right panel of \fig{butterfly_lat}.

One measure of the noise contained in the $f$-mode strength is the standard deviation of the fluctuations
around the signal. This is calculated in each bin as
\begin{equation}
\sigma= \sqrt{\frac{1}{N_P}\sum_{\mbox{patch}} ( f(\lambda,t)
- \left<f_P\right>)^2}.
\end{equation}
From this we form the average error at each latitude by taking an average over time and denote as $\overline{\sigma}$. 
%AL added
This quantity is plotted as the error bar in the right panel of \fig{butterfly_lat}.

%NO Adding some words how we verified significance
As the average error described above does not necessarily prove that the patterns seen in the left panel of \fig{butterfly_lat} are statistically significant, we did more detailed analysis and estimated the significance of $\left< f' \right>$ for each patch separately. The following test was made: For all quiet sun patches we computed the power of noise in the azimuthally averaged spectra similarly as for $f$-modes. We assumed that noise level is independent of $k$ and selected the region towards higher $k$ values, where the $f$-mode is already decayed. Then we calculated fluctuations in the noise power $\left< f'_{\rm noise} \right>$ in an identical manner as for $\left< f' \right>$.
The analysis showed that for all patches $\left< f'_{\rm noise} \right>$ was an order of magnitude weaker than the corresponding $\left< f' \right>$.

%AL BEGIN unnecessary stuff
\color{cyan}
\subsection*{All the stuff below this line not needed !!!}
Error definitions:\\
$\lambda$ = latitude, $t$=time, \\
$N_t$ = number of bins (time), \\
$N_\lambda$ = number of bins (latitude), \\
$N_P$ = number of $f$-mode measurements in a patch, \\
$\overline{X}$ indicates average over time, \\
$f(\lambda,t)$ = $f$-mode strength (unbinned)\\
$f_P(\lambda,t)$ = $f$-mode strength in latitude / time bins (patches)\\
$\overline{f}(\lambda) = 1/N_t \sum_t f(\lambda,t)$ = temporal mean of the $f$-mode strength (unbinned)\\ 
$f'=f-\overline{f}$ is the fluctuation around the temporal mean, i.e. the solar cycle dependence of the $f$-mode (unbinned)\\
$\overline{f_P}(\lambda) = 1/N_t \sum_t f_P(\lambda,t)$ = temporal mean of 
$f$-mode strength (in lat / time bins), \\
$f'_P=f_P-\overline{f_P}$ is, correspondingly, the binned fluctuation\\

%AL added this
The following 4 definitions represent what is plotted in \fig{butterfly_lat_old}:
\begin{itemize}
\item sdev(cycle) 
%AL added the subsript cyc to indicate that this sigma is computed  over the whole cycle, and to distinguish it from \sigma_P
%$\sigma(\lambda)$ 
$\sigma_{\mbox{cyc}}(\lambda)$ 
(red shaded area): this quantity displays the variation of the $f$-mode over the solar cycle.
%AL added
the subscript 'cyc' should indicate that this variation includes also the solar cycle variation. This distinguishes it from $\sigma_P$ defined below, which does not contain the solar cycle variation.
\begin{equation}
%MJK I think subscript P is missing from here, and the need for 'cyc' I cannot understand.
%AL correct. The P was missing. I tried to explain the 'cyc'
%\sigma^2_{\mbox{cyc}}(\lambda) 
%AL commented out this:
%\sigma_P^2(\lambda)  = 
%AL and changed it to:
\sigma^2_{\mbox{cyc}}(\lambda) =
\frac{1}{N_t} \sum_{t} \left( f_P(\lambda,t) -\overline{f_P}(\lambda)\right)^2,
\end{equation}
%MJK added this
hence equalling to the rms value of $f'_P$ (without taking the square root). 
%MJK

\item min/max $\sigma_{\mbox{mm}}$: (blue shaded area): this shows the minimum and the maximum  of $f(\lambda,t) - \overline{f}(\lambda)$:
\begin{equation}
\sigma_{\mbox{mm}}(\lambda) = [ \min_t (f(\lambda,t)),  \max_t (f(\lambda,t)) ] -\overline{f}(\lambda)
\end{equation}

\item min/max (mean) $\overline{\sigma}_{\mbox{mm}}$: (green shaded area): this shows the mean minimum and maximum  of $f(\lambda,t) - \overline{f}(\lambda)$:
\begin{equation}
\overline{\sigma}_{\mbox{mm}}(\lambda) = [ \overline{ \min_t (f(\lambda,t)) }, \overline{ \max_t (f(\lambda,t)) }] -\overline{f}(\lambda)
\end{equation}

\item mean(sdev(patch)) $\overline{\sigma_P}$ (error bars): the standard deviation of the $f$-mode strength
%AL added this
($f(\lambda,t)$)
%AL
 is computed individually for all lat / time bins. This quantity  ($=\sigma_P(\lambda,t)$) is then averaged over time:
\begin{eqnarray}
\overline{\sigma_P}(\lambda) &=&  \frac{1}{N_t} \sum_{t}  \sigma_P(\lambda,t) \mbox{, with} \\
\sigma_P^2(\lambda,t) &=& \frac{1}{N_P}\sum_{\mbox{patch}} ( f(\lambda,t)
- f_P(\lambda,t) )^2,
\end{eqnarray} 
%AL added this
where $\sum_{\mbox{patch}}$ indicates the summation over all $f$-mode strengths within a patch, and $f_P(\lambda,t)$ being the mean $f$-mode strength in this patch. The patch size must be chosen small enough to not contain a significant variation in latitude or solar cycle. 
This quantity $\overline{\sigma_P}(\lambda)$ is displayed as the orange shaded area in \fig{butterfly_lat}.\\
%MJK Added this
This quantity is, therefore, a mean of the $f'_{P, {\rm rms}}$ (so this time also taking the square root) values in individual bins. The problem is that the quantity we are interested in inspecting, and defining the significance of, is now defining the error bar of the measurement. 
%MJK
%AL comment:
%My definition is maybe poor. Yes, I think it should be simply called the 'average rms fluctuation of the f-mode strength over 2 months' (in the above plot the patch size in time is 2 months).
\end{itemize}
\subsection*{All the stuff above this line not needed !!!}
\color{black}
%AL END unnecessary stuff


\colfigtwocol{butterfly_lat}{Butterfly diagram of $f$-mode strength (left panel). The latitudinal average over time, displayed in the right panel, was removed for better visibility of the variation. The error bar, plotted on the latitudinal average of the $f$-mode strength, represents the time averaged standard deviation of the fluctuations of the $f$-mode strength around the signal for every bin ($\overline{\sigma (\lambda)}$). The orange shaded area shows the amplitude of the solar cycle variation ($f'_A(\lambda)$). 
%The horizontal lines in the colorbar indicate $\pm \overline{\sigma_P}(\lambda)$.
 }


%AL removed this figure
%\colfig{butterfly_lat_old}{Old version of the diagram, showing the attempts to define the error, and matching the color description from equations (1)-(4).}

\section{Discussion}

\begin{acknowledgements}
All SDO data used are publicly available from the Joint Science Operations Center (JSOC) at Stanford University supported by NASA Contract NAS5- 02139 (HMI), see http://jsoc.stanford.edu/. 
\todo{German DataCenter?}
\end{acknowledgements}

\bibliography{main}{}
\bibliographystyle{aasjournal}

\end{document}
